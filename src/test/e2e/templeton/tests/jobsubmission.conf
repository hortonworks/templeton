###############################################################################
# curl command tests for templeton
#
#

#use Yahoo::Miners::Test::PigSetup;

#PigSetup::setup();

#my $me = `whoami`;
#chomp $me;

$cfg = 
{
 'driver' => 'Curl',

 'groups' => 
 [
##=============================================================================================================
  {
   'name' => 'TestKillJob',
   'tests' => 
   [
    {
     'num' => 1,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/mapreduce/streaming',
     'post_options' => ['user.name=:UNAME:','input=:INPDIR_HDFS:/nums.txt',
                        'input=:INPDIR_HDFS:/nums.txt',
                        'output=:OUTDIR:/mycounts', 
                        'mapper=sleep 100', 'reducer=wc'],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'KILLED',
#     'check_call_back' => 1, #TODO - enable call back check after fix
     'kill_job_timeout' => 10,
    },
   ]
  },
##=============================================================================================================
  {
   'name' => 'TestMapReduce',
   'tests' => 
   [
    {
         
     'num' => 1,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/mapreduce/jar',
     'post_options' => ['user.name=:UNAME:','arg=:INPDIR_HDFS:/nums.txt', 'arg= :OUTDIR:/wc.txt', 
                        'jar=:INPDIR_HDFS:/hexamples.jar', 'class=wordcount', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },
    {
         
     'num' => 2,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/mapreduce/jar',
     'post_options' => ['user.name=:UNAME:','arg=-mt', 'arg=660000', 
                        'jar=:INPDIR_HDFS:/hexamples.jar', 'class=sleep', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
     'timeout' => 840, #increase timeout as this test takes long
    },
	{
     # with log enabled 
     'num' => 3,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/mapreduce/jar',
     'post_options' => ['user.name=:UNAME:','arg=:INPDIR_HDFS:/nums.txt', 'arg= :OUTDIR:/wc.txt', 
                        'jar=:INPDIR_HDFS:/hexamples.jar', 'class=wordcount', 'statusdir=:OUTDIR:/status', 'enablelog=true' ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_logs' => { 'job_num' => '1' },
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },
    {
	 # custom config 1 : using mapred.job.reuse.jvm.num.tasks to valid values         
     'num' => 4,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/mapreduce/jar',
     'post_options' => ['user.name=:UNAME:','arg=-mt', 'arg=660000', 
                        'jar=:INPDIR_HDFS:/hexamples.jar', 'class=sleep', 'define=mapred.job.reuse.jvm.num.tasks=2' ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
     'timeout' => 840, #increase timeout as this test takes long
    },
    {
	 # custom config 2 : using mapred.job.reuse.jvm.num.tasks to -1         
     'num' => 5,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/mapreduce/jar',
     'post_options' => ['user.name=:UNAME:','arg=-mt', 'arg=660000', 
                        'jar=:INPDIR_HDFS:/hexamples.jar', 'class=sleep', 'define=mapred.job.reuse.jvm.num.tasks=-1' ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
     'timeout' => 840, #increase timeout as this test takes long
    },	
    {

	#custom config 3 : using mapred.job.reuse.jvm.num.tasks to invalid value
	# this should still set the value to default which is 1         
     'num' => 6,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/mapreduce/jar',
     'post_options' => ['user.name=:UNAME:','arg=-mt', 'arg=660000', 
                        'jar=:INPDIR_HDFS:/hexamples.jar', 'class=sleep', 'define=mapred.job.reuse.jvm.num.tasks=-10' ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
     'timeout' => 840, #increase timeout as this test takes long
    },		
   ]
  },
##=============================================================================================================
  {
   'name' => 'TestPig',
   'tests' => 
   [
    {
                                #test syntax error
     'num' => 1,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:','execute=asdf', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_exit_value' => 8,
     'check_call_back' => 1,
    },
    {
                                #valid syntax, hdfs operation through pig
     'num' => 2,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:','execute=fs -ls :INPDIR_HDFS:;', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },
    {
                                #syntax check  - valid syntax
     'num' => 3,
       'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:','arg=-check', 'file=:INPDIR_HDFS:/loadstore.pig', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },
    {
                                #syntax check cmd - valid syntax
     'num' => 4,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:', 'arg=-d', 'arg=INFO' , 'execute=fs -ls :INPDIR_HDFS: ', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },

    {
                                #a simple load store script
     'num' => 5,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', 'file=:INPDIR_HDFS:/loadstore.pig', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },


    {
                                #pig query registering jar
     'num' => 6,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', 'file=:INPDIR_HDFS:/jarregistered.pig',
                        'files=:INPDIR_HDFS:/piggybank.jar' ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },

    {
                                #macro
     'num' => 7,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', 'file=:INPDIR_HDFS:/rowcount_withmacro.pig',
                        'files=:INPDIR_HDFS:/rowcountmacro.pig' ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },

    {
                                #no file to be copied, should result in launcher job error 
     'num' => 8,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', 'file=:INPDIR_HDFS:/no_such_file.pig',
                        'files=:INPDIR_HDFS:/rowcountmacro.pig' ],
     'json_field_substr_match' => { 'error' => 'does not exist'},
                                #results
     'status_code' => 400,

    },
	
	{
                                #Auto add quote around args
     'ignore' => 'MS9 feature, will reenable later',
     'num' => 9,
       'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:','arg=-check', 'file=:INPDIR_HDFS:/loadstore.pig', 'arg=-p', 'arg=INPDIR=:INPDIR_HDFS:','arg=-p', 'arg=OUTDIR=:OUTDIR:', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },
	
	{
                                #a simple load store script with log enabled
     'num' => 10,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:', 'arg=-p', 'arg=INPDIR=:INPDIR_HDFS:','arg=-p', 'arg=OUTDIR=:OUTDIR:', 'file=:INPDIR_HDFS:/loadstore.pig',
                    'statusdir=:OUTDIR:/status', 'enablelog=true'],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_logs' => { 'job_num' => '1' },
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },

    #test 11
    #TODO jython test
	
   ]
  },
##=============================================================================================================
  {
   'name' => 'TestHive',
   'tests' => 
   [
    {
                                #test syntax error
     'num' => 1,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',
     'post_options' => ['user.name=:UNAME:','execute=asdf', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_exit_value' => 40000,

    },
 
    {
                                #test show tables
     'num' => 2,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',
     'post_options' => ['user.name=:UNAME:','execute=show tables', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },

    {
                                #test show tables
     'num' => 3,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',
     'post_options' => ['user.name=:UNAME:','execute=drop table if exists mynums;', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },
    {
                                #test show tables
     'num' => 4,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',
     'post_options' => ['user.name=:UNAME:','execute=create external table mynums(a int, b int) location \':INPDIR_HDFS:/numstable/\';', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },

    {
                                #test describe
     'num' => 5,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',
     'post_options' => ['user.name=:UNAME:','execute=describe formatted mynums', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },

    {
                                #test select *
     'num' => 6,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',
     'post_options' => ['user.name=:UNAME:','execute=select * from mynums', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },

    {
                                #test select a,b
     'num' => 7,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',	
     'post_options' => ['user.name=:UNAME:','execute=select a,b from mynums', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,

    },


    {
                                #test udfs : select a,rand(b)
     'num' => 8,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',
     'post_options' => ['user.name=:UNAME:','execute=select a,rand(b) from mynums', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,

    },

    {
                                #test add jar
     'num' => 9,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',
     'post_options' => ['user.name=:UNAME:','execute=add jar piggybank.jar', 'files=:INPDIR_HDFS:/piggybank.jar',],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },
    {
                                #test add jar when the jar is not shipped
     'num' => 10,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',
     'post_options' => ['user.name=:UNAME:','execute=add jar piggybank.jar',],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS', 
     'check_job_exit_value' => 1,
     'check_call_back' => 1,
    }, 
										
    {
								# get all the details of the job
     'num' => 11,
     'depends_on' => 'TestHive_1,TestHive_2,TestHive_3,TestHive_4,TestHive_5,TestHive_6,TestHive_7,TestHive_8,TestHive_9,TestHive_10',
     'method' => 'GET',
     'url' => ':TEMPLETON_URL:/templeton/v1/jobs?user.name=:UNAME:&fields=*',
     'format_header' => 'Content-Type: application/json',
     'json_path' => {'$[-1:].detail.user' => ':UNAME:',
                     '$[-2:].detail.user' => ':UNAME:',
					 '$[-3:].detail.user' => ':UNAME:',
					 '$[-4:].detail.user' => ':UNAME:',
					 '$[-5:].detail.user' => ':UNAME:',
					 '$[-6:].detail.user' => ':UNAME:',
					 '$[-7:].detail.user' => ':UNAME:',
					 '$[-8:].detail.user' => ':UNAME:',
					 '$[-9:].detail.user' => ':UNAME:',
					 '$[-10:].detail.user' => ':UNAME:',
                    },
     'status_code' => 200,
    }, 	
	
    {
                                #enable logs
     'num' => 12,
     'ignore23' => 'Log collector does not work with Hadoop 2',
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/hive',	
     'post_options' => ['user.name=:UNAME:','execute=select a,b from mynums', 'statusdir=:OUTDIR:/status', 'enablelog=true'],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_logs' => { 'job_num' => '1' },
     'check_job_exit_value' => 0,
     'check_call_back' => 1,
    },	
	
   ]
  },
 ]
},
  ;

