###############################################################################
# curl command tests for templeton
#
#

#use Yahoo::Miners::Test::PigSetup;

#PigSetup::setup();

#my $me = `whoami`;
#chomp $me;

$cfg = 
{
 'driver' => 'Curl',

 'groups' => 
 [

##=============================================================================================================
  # Launch multiple jobs and check that all complete
  # And TempletonController jobs end up in the 'joblauncher' queue 
  {
   'name' => 'CONCURRENCY',
   'tests' => 
   [
    {
     #a simple load store script as UNAME_OTHER
     'num' => 1,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME_OTHER:', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', 'file=:INPDIR_HDFS:/loadstore.pig', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_call_back' => 1,
    },
    {
     #a simple load store script as UNAME
     'num' => 2,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', 'file=:INPDIR_HDFS:/loadstore.pig', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_call_back' => 1,
    },
    {
     #a simple load store script as UNAME_OTHER
     'num' => 3,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME_OTHER:', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', 'file=:INPDIR_HDFS:/loadstore.pig', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_call_back' => 1,
    },
    {
     #a simple load store script as UNAME
     'num' => 4,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME:', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', 'file=:INPDIR_HDFS:/loadstore.pig', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_call_back' => 1,
    },
    {
     #a simple load store script as UNAME_OTHER
     'num' => 5,
     'method' => 'POST',
     'url' => ':TEMPLETON_URL:/templeton/v1/pig',
     'post_options' => ['user.name=:UNAME_OTHER:', 'arg=-p', 'arg="INPDIR=:INPDIR_HDFS:"','arg=-p', 'arg="OUTDIR=:OUTDIR:"', 'file=:INPDIR_HDFS:/loadstore.pig', ],
     'json_field_substr_match' => { 'id' => '\d+'},
                                #results
     'status_code' => 200,
     'check_job_created' => 1,
     'check_job_complete' => 'SUCCESS',
     'check_call_back' => 1,
    },
	{
     # We will get the last 5 templeton controller jobs and match the queue name to be "joblauncher"
     # Since CONCURRENCY_1, CONCURRENCY_2, CONCURRENCY_3, CONCURRENCY_4, CONCURRENCY_5 are run before this, 
     # there will be atleast 5 templeton controller jobs
     # There could be more from previous runs, hence we are interested in the last 5
     # Also, default test cluster will have 3 Map slots in joblauncher queue and 3 in default queue
     # Launching more than 3 jobs should not block the progress 
     'num' => 6,
     'depends_on' => 'CONCURRENCY_1, CONCURRENCY_2, CONCURRENCY_3, CONCURRENCY_4, CONCURRENCY_5',
     'method' => 'GET',
     'url' => ':TEMPLETON_URL:/templeton/v1/jobs?user.name=:UNAME_OTHER:&showall=true&fields=*',
     'format_header' => 'Content-Type: application/json',
     'json_path' => {'$[-1:].detail.profile.queueName' => 'joblauncher', '$[-2:].detail.profile.queueName' => 'joblauncher', '$[-3:].detail.profile.queueName' => 'joblauncher', 
     				'$[-4:].detail.profile.queueName' => 'joblauncher', '$[-4:].detail.profile.queueName' => 'joblauncher', },
     'status_code' => 200,
     'check_templeton_queue_name' => 1,
    },
   ]
  }
 ]
}
;
